var io={logLevel:1,offline:false,gadFilter:"",addonDriverFile:"",driverVersion:"1.08",address:"",port:"",read:function(a){io.log(1,"read (item="+a+")")},write:function(a,d){if(io.offline){}else{var c=false;if(io.gadFilter){var b=new RegExp(io.gadFilter);c=b.test(a)}if(c){if(io.addon){io.addon.write(a,d)}}else{io.log(2,"write (gad="+a+" val="+d+")");io.send({cmd:"item",id:a,val:d})}}io.updateWidget(a,d)},trigger:function(a,b){if(io.addon){io.addon.trigger(a,b)}},init:function(a,b){io.log(0,"init [V"+io.driverVersion+"] (address="+a+" port="+b+")");io.address=a;io.port=b;if(a==="offline"){io.offline=true}if(io.offline){io.log(0,"DRIVER IS IN OFFLINE MODE")}else{io.open();if(io.addonDriverFile){$.getScript("driver/"+io.addonDriverFile).done(function(d,c){io.addon=new addonDriver();io.addon.init(io);io.addon.run()}).fail(function(e,d,c){io.addon=null})}}},run:function(a){if(io.offline){io.log(1,"run (OFFLINE)");io.monitor();io.simulateData();if(io.timer){clearInterval(io.timer)}io.timer=setInterval(function(){io.simulateData()},5000)}else{io.log(1,"run (readyState="+io.socket.readyState+")");io.resetLoadTime();if(io.addon){io.addon.run()}if(io.socket.readyState>1){io.open()}else{io.refreshWidgets();io.monitor()}}},protocolVersion:"0.1",socket:null,rcTimer:null,addon:null,log:function(b,a){if(io.logLevel>=b){console.log("[io.fhem]: "+a)}},startReconnectTimer:function(){if(!io.rcTimer){io.log(1,"Reconnect timer started");io.rcTimer=setInterval(function(){io.log(1,"Reconnect timer fired");notify.add("ConnectionLost","connection","Driver: fhem","Connection to the fhem server lost!");notify.display();if(!io.socket){io.open()}},60000)}},stopReconnectTimer:function(){if(io.rcTimer){clearInterval(io.rcTimer);io.rcTimer=null;io.log(1,"Reconnect timer stopped")}},callUpdateHandler:function(c,b){var a=io.action[$(c).attr("data-widget")];if(a){a.handler.call(c,"update",b)}else{$(c).trigger("update",b)}},refreshWidgets:function(){$('[id^="'+$.mobile.activePage.attr("id")+'-"][data-item]').each(function(a){var b=widget.get(widget.explode($(this).attr("data-item")));if(widget.check(b)){io.callUpdateHandler(this,b)}})},updateWidget:function(a,b){io.receivedGADs++;io.logLoadTime("GAD #"+io.receivedGADs);var c="";if(b===undefined||widget.buffer[a]!==b||(widget.buffer[a] instanceof Array&&widget.buffer[a].toString()!=b.toString())){widget.set(a,b);$('[data-item*="'+a+'"]').each(function(d){c=$(this).attr("data-widget");var f=widget.explode($(this).attr("data-item"));for(var g=0;g<f.length;g++){if(f[g]==a){var e=Array();var h=c.substr(0,5)=="plot.";if(h&&$("#"+this.id).highcharts()){}else{e=widget.get(f);if(widget.check(e)){io.callUpdateHandler(this,e)}}}}})}io.logLoadTime("OK ("+c+")");io.showLoadTime()},updateChart:function(a,b,c){$('[data-item*="'+a+'"]').each(function(d){var e=widget.explode($(this).attr("data-item"));for(var g=0;g<e.length;g++){if(e[g]===a){var f={gad:a,data:b};io.callUpdateHandler(this,f);io.log(2,"series updated: "+f.gad+" size: "+f.data.length);break}}})},handleReceivedData:function(h){var e=0;var d=JSON.parse(h);switch(d.cmd){case"reloadPage":location.reload(true);break;case"item":for(e=0;e<d.items.length;e=e+2){var j=d.items[e];var a=d.items[e+1];io.updateWidget(j,a)}break;case"series":for(e=0;e<d.items.length;e++){var b=d.items[e].gad;var c=d.items[e].plotdata;var g=d.items[e].updatemode;io.updateChart(b,c,g)}break;case"dialog":notify.info(d.header,d.content);break;case"proto":var f=d.ver;if(f!=io.protocolVersion){notify.info("Driver: fhem","Protocol mismatch<br />Driver is at version v"+io.protocolVersion+"<br />fhem is at version v"+f)}break;case"log":break}},open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.log(2,"socket.onopen");io.stopReconnectTimer();io.send({cmd:"proto",ver:io.protocolVersion});io.monitor();if(notify.exists()){notify.remove()}};io.socket.onmessage=function(a){io.log(2,"socket.onmessage: data= "+a.data);io.handleReceivedData(a.data)};io.socket.onerror=function(a){io.log(1,"socket.onerror: "+a)};io.socket.onclose=function(){io.log(1,"socket.onclose");io.close();io.startReconnectTimer()}},send:function(a){if(io.offline){io.log(2,"OFFLINE send() data: "+JSON.stringify(a))}else{if(io.socket.readyState==1){io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))));io.log(2,"send() data: "+JSON.stringify(a))}}},splitGADs:function(){io.ownGADs=[];io.fhemGADs=[];var c=Array();var g=Array();io.allGADs.forEach(function(k){var l=$(k).attr("data-widget");if(!(l=="status.log"||l.lastIndexOf("chart.",0)===0)||l.lastIndexOf("plot.",0)===0){var h=widget.explode($(k).attr("data-item"));for(var j=0;j<h.length;j++){if(!widget.checkseries(h[j])){g[h[j]]=""}}}});for(var f in g){c.push(f);if(io.offline){io.offlineGADs.push(f)}}if(io.gadFilter){var e=new RegExp(io.gadFilter);for(var d=0;d<c.length;d++){var a=c[d];var b=e.test(a);if(b){io.ownGADs.push(a)}else{io.fhemGADs.push(a)}}}else{io.fhemGADs=c}},splitCharts:function(){io.ownSeries=[];io.fhemSeries=[];io.allGADs.forEach(function(d){var h=$(d).attr("data-widget");if(h.lastIndexOf("chart.",0)==0){var a=$(d).attr("data-item").split(",");var f=$(d).attr("data-modes");var e=f.split(",");for(var b=0;b<a.length;b++){var g={gad:a[b].trim(),mode:e.length>1?e[b].trim():f,start:$(d).attr("data-tmin"),end:$(d).attr("data-tmax"),interval:$(d).attr("data-interval"),minzoom:$(d).attr("data-zoom"),updatemode:"complete"};if(io.offline){io.offlineSeries.push(g)}if(io.gadFilter){var c=new RegExp(io.gadFilter);if(c.test(g.gad)){io.ownSeries.push(g)}else{io.fhemSeries.push(g)}}else{io.fhemSeries.push(g)}}}})},splitLogs:function(){io.ownLogs=[];io.fhemLogs=[];io.allGADs.forEach(function(e){var g=$(e).attr("data-widget");if(g==="status.log"){var a=$(e).attr("data-item");var f=a.split(",");for(var b=0;b<f.length;b++){var d={gad:f[b].trim(),size:$(e).attr("data-count"),interval:$(e).attr("data-interval")};if(io.offline){io.offlineLogs.push(d)}if(io.gadFilter){var c=new RegExp(io.gadFilter);if(c.test(d.gad)){io.ownLogs.push(d)}else{io.fhemLogs.push(d)}}else{io.fhemLogs.push(d)}}}})},getAllGADs:function(){io.action={};io.allGADs=[];var a=($._data($(document)[0],"events")||{})["update"];for(var c=0;c<a.delegateCount;c++){var b=a[c].selector;var f=/.*?data-widget="(.+?)".*/;f.exec(b);var e=RegExp.$1;var d=a[c].handler;io.action[e]={handler:d}}if($.mobile.activePage){$('[id^="'+$.mobile.activePage.attr("id")+'-"][data-item]').each(function(g,h){io.allGADs.push(this)})}},allGADs:[],fhemGADs:[],ownGADs:[],fhemSeries:[],ownSeries:[],fhemLogs:[],ownLogs:[],monitor:function(){if(io.offline||io.socket.readyState==1){io.logLoadTime("Monitor");io.getAllGADs();io.splitGADs();io.splitCharts();io.splitLogs();io.logLoadTime("Monitor done");io.log(1,"monitor (GADs:"+io.fhemGADs.length+", Series:"+io.fhemSeries.length+")");if(io.fhemGADs.length){io.send({cmd:"monitor",items:io.fhemGADs})}if(io.fhemSeries.length){io.send({cmd:"series",items:io.fhemSeries})}if(io.fhemLogs.length){io.send({cmd:"log",items:io.fhemLogs})}if(io.addon){io.addon.monitor(io.ownGADs,io.ownSeries,io.ownLogs)}}},close:function(){if(io.socket!=null){io.socket.close();io.socket=null;io.log(1,"socket closed")}},gadsToMeasure:20,loadTimeLog:"Load-Times\n",timeStamp:0,receivedGADs:0,resetLoadTime:function(){io.receivedGADs=0;io.loadTimeLog="Load-Times\n";io.logLoadTime("Start")},logLoadTime:function(c){var b=new Date();var a=io.timeStamp==0?0:(b.getTime()-io.timeStamp);io.loadTimeLog+=b.toLocaleTimeString()+"."+("000"+b.getMilliseconds()).slice(-3)+" ("+a+" ms): "+c+"\n";io.timeStamp=b.getTime()},showLoadTime:function(){if(io.receivedGADs==io.gadsToMeasure){if(io.loadTimeLog){io.logLoadTime(io.receivedGADs+" GADs")}}},timer:null,offlineGADs:[],offlineSeries:[],offlineLogs:[],simulateData:function(){for(h=0;h<io.offlineGADs.length;h++){var g=[];g.push(io.offlineGADs[h]);g.push((Math.random()*100).toFixed(1));io.handleReceivedData('{"cmd":"item", "items": '+JSON.stringify(g)+"}")}var b=new Date().getTime();for(var h=0;h<io.offlineSeries.length;h++){var k=$('[data-item*="'+io.offlineSeries[h].gad+'"]')[0];var m=100;var o=$(k).attr("data-ymin");o=o?o*1:0;var e=$(k).attr("data-ymax");e=e?e*1:255;var a=new Date().getTime()-new Date().duration($(k).attr("data-tmin"));var j=new Date().getTime()-new Date().duration($(k).attr("data-tmax"));var d=Math.round((j-a)/m);var c=o+((e-o)/2);var n=(e-o)/20;var f=[];while(a<=j){c+=Math.random()*(2*n)-n;f.push([a,c.toFixed(2)*1]);a+=d}var l='{"cmd":"series", "items": [{"gad": "'+io.offlineSeries[h].gad+'", "updatemode": "complete", "plotdata": '+JSON.stringify(f)+" }]}";io.handleReceivedData(l)}}};