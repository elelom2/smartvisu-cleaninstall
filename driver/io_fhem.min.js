var io={logLevel:1,gadFilter:"",addonDriverFile:"",driverVersion:"1.02",address:"",port:"",read:function(a){io.log(1,"read (item="+a+")")},write:function(a,d){var c=false;if(io.gadFilter){var b=new RegExp(io.gadFilter);c=b.test(a)}if(c){if(io.addon){io.addon.write(a,d)}}else{io.log(2,"write (gad="+a+" val="+d+")");io.send({cmd:"item",id:a,val:d})}io.updateWidget(a,d)},trigger:function(a,b){if(io.addon){io.addon.trigger(a,b)}},init:function(a,b){io.log(1,"init [V"+io.driverVersion+"] (address="+a+" port="+b+")");io.address=a;io.port=b;io.open();if(io.addonDriverFile){$.getScript("driver/"+io.addonDriverFile).done(function(d,c){io.addon=new addonDriver();io.addon.init(io);io.addon.run()}).fail(function(e,d,c){io.addon=null})}},run:function(a){io.log(1,"run (readyState="+io.socket.readyState+")");if(io.addon){io.addon.run()}if(io.socket.readyState>1){io.open()}else{io.refreshWidgets();io.monitor()}},protocolVersion:"0.1",socket:null,rcTimer:null,addon:null,log:function(b,a){if(io.logLevel>=b){console.log("[io.fhem]: "+a)}},startReconnectTimer:function(){if(!io.rcTimer){io.log(1,"Reconnect timer started");io.rcTimer=setInterval(function(){io.log(1,"Reconnect timer fired");notify.add("ConnectionLost","connection","Driver: fhem","Connection to the fhem server lost!");notify.display();if(!io.socket){io.open()}},60000)}},stopReconnectTimer:function(){if(io.rcTimer){clearInterval(io.rcTimer);io.rcTimer=null;io.log(1,"Reconnect timer stopped")}},refreshWidgets:function(){$('[id^="'+$.mobile.activePage.attr("id")+'-"][data-item]').each(function(a){setTimeout(function(c){var b=widget.get(widget.explode($(c).attr("data-item")));if(widget.check(b)){$(c).trigger("update",[b])}},2,this)})},updateWidget:function(a,b){setTimeout(function(d,c){widget.update(d,c);io.log(2,"item updated: "+d+" val: "+c)},1,a,b)},updatePlot:function(b,a){setTimeout(function(d,c){widget.update(d,c);io.log(2,"series updated: "+d+" size: "+c.length)},1,b,a)},open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.log(2,"socket.onopen()");io.stopReconnectTimer();io.send({cmd:"proto",ver:io.protocolVersion});io.monitor();if(notify.exists()){notify.remove()}};io.socket.onmessage=function(d){var c,f;var e=JSON.parse(d.data);io.log(2,"onmessage() data= "+d.data);switch(e.cmd){case"reloadPage":location.reload(true);break;case"item":for(var a=0;a<e.items.length;a=a+2){c=e.items[a];f=e.items[a+1];io.updateWidget(c,f)}break;case"series":break;case"dialog":notify.info(e.header,e.content);break;case"proto":var b=e.ver;if(b!=io.protocolVersion){notify.info("Driver: fhem","Protocol mismatch<br />Driver is at version v"+io.protocolVersion+"<br />fhem is at version v"+b)}break;case"log":break}};io.socket.onerror=function(a){io.log(1,"socket.onerror: "+a)};io.socket.onclose=function(){io.log(1,"socket.onclose");io.close();io.startReconnectTimer()}},send:function(a){if(io.socket.readyState==1){io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))));io.log(2,"send() data: "+JSON.stringify(a))}},splitGADs:function(){io.ownGADs=[];io.fhemGADs=[];var c=widget.listeners();if(io.gadFilter){var e=new RegExp(io.gadFilter);for(var d=0;d<c.length;d++){var a=c[d];var b=e.test(a);if(b){io.ownGADs.push(a)}else{io.fhemGADs.push(a)}}}else{io.fhemGADs=c}},splitPlots:function(){io.ownSeries=[];io.fhemSeries=[];var a=widget.plot();widget.plot().each(function(k){var b=$(this).attr("data-item");var h=b.split(",");for(var f=0;f<h.length;f++){var g=h[f].split(".");var d="";for(var e=0;e<g.length-3;e++){d+=((d.length==0?"":".")+g[e]).trim()}var c={gad:d,mode:g[g.length-3],start:g[g.length-2],end:g[g.length-1]};if(io.gadFilter){var l=new RegExp(io.gadFilter);if(l.test(c.gad)){io.ownSeries.push(c)}else{io.fhemSeries.push(c)}}else{io.fhemSeries.push(c)}}})},fhemGADs:[],ownGADs:[],fhemSeries:[],ownSeries:[],monitor:function(){if(io.socket.readyState==1){io.splitGADs();io.splitPlots();io.log(1,"monitor (GADs:"+io.fhemGADs.length+", Series:"+io.fhemSeries.length+")");if(io.fhemGADs.length){io.send({cmd:"monitor",items:io.fhemGADs})}if(io.fhemSeries.length){}if(io.addon){io.addon.monitor(io.ownGADs,io.ownSeries,[])}}},close:function(){if(io.socket!=null){io.socket.close();io.socket=null;io.log(1,"socket closed")}}};