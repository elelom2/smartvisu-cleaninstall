 var io={logLevel:1,alertExceptions:false,offline:false,measureGADs:false,gadsToMeasure:10,gadFilter:"",addonDriverFile:"",driverVersion:"1.10",address:"",port:"",read:function(a){io.log(1,"read (item="+a+")")},write:function(a,d){if(io.offline){}else{var c=false;if(io.gadFilter){var b=new RegExp(io.gadFilter);c=b.test(a)}if(c){if(io.addon){io.addon.write(a,d)}}else{io.log(2,"write (gad="+a+" val="+d+")");io.send({cmd:"item",id:a,val:d})}}io.updateWidget(a,d)},trigger:function(a,b){if(io.addon){io.addon.trigger(a,b)}},init:function(a,b){io.log(0,"init [V"+io.driverVersion+"] (address="+a+" port="+b+")");io.address=a;io.port=b;if(io.alertExceptions){window.onerror=function(e,d,c){alert("Error: "+e+"\nurl: "+d+"\nline: "+c);return false}}if(a==="offline"){io.offline=true}if(io.offline){io.log(0,"DRIVER IS IN OFFLINE MODE")}else{io.open();if(io.addonDriverFile){$.getScript("driver/"+io.addonDriverFile).done(function(d,c){io.addon=new addonDriver();io.addon.init(io);io.addon.run()}).fail(function(e,d,c){io.addon=null})}}},run:function(a){if(io.offline){io.log(1,"run (OFFLINE)");io.monitor();io.simulateData();if(io.timer){clearInterval(io.timer)}io.timer=setInterval(function(){io.simulateData()},5000)}else{io.log(1,"run (readyState="+io.socket.readyState+")");io.resetLoadTime();if(io.addon){io.addon.run()}if(io.socket.readyState>1){io.open()}else{io.monitor()}}},protocolVersion:"0.1",socket:null,rcTimer:null,addon:null,log:function(b,a){if(io.logLevel>=b){console.log("[io.fhem]: "+a)}},startReconnectTimer:function(){if(!io.rcTimer){io.log(1,"Reconnect timer started");io.rcTimer=setInterval(function(){io.log(1,"Reconnect timer fired");notify.add("ConnectionLost","connection","Driver: fhem","Connection to the fhem server lost!");notify.display();if(!io.socket){io.open()}},60000)}},stopReconnectTimer:function(){if(io.rcTimer){clearInterval(io.rcTimer);io.rcTimer=null;io.log(1,"Reconnect timer stopped")}},callUpdateHandler:function(e,b){var f=$(e).attr("data-widget");var c=$(e).attr("data-item");var a=io.action[f];try{if(a){a.handler.call(e,"update",b)}else{$(e).trigger("update",b)}}catch(d){io.log(0,"Widget '"+f+"' - "+c+": "+b+" Error: "+d)}},updateWidget:function(a,b){io.receivedGADs++;var c="";io.logLoadTime("GAD #"+io.receivedGADs);if(!(widget.buffer[a] instanceof Array)&&b!==undefined){widget.buffer[a]=$.isNumeric(b)?b*1:b}$('[data-item*="'+a+'"]').each(function(e){c=$(this).attr("data-widget");var g=widget.explode($(this).attr("data-item"));var k=$(this).attr("data-series");for(var j=0;j<g.length;j++){if(g[j]==a){if(k){var l={gad:a,data:b};io.callUpdateHandler(this,l)}else{var f=widget.get(g);if(widget.check(f)){io.callUpdateHandler(this,f);if(c.lastIndexOf("icon.",0)===0){var d=io.action["icon."];try{if(d){d.handler.call(this,"update",f)}else{$(this).trigger("update",f)}}catch(h){io.log(0,"Widget '"+c+"' - "+a+": "+f+" Error: "+h)}}}}}}});io.logLoadTime("OK ("+c+")");io.showLoadTime()},updateChart:function(c,a,b,d){seriesData={gad:a,data:b,updatemode:d};io.callUpdateHandler(c,seriesData);io.log(2,"Chart updated: "+a+" size: "+b.length)},updatePlot:function(f,a,e,g){var c=widget.explode($(f).attr("data-item"));for(var d=0;d<c.length;d++){c[d]=io.splitPlotGAD(c[d]).gad}widget.buffer[a]=e;if($(f).attr("data-widget").substr(0,5)=="plot."&&$("#"+f.id).highcharts()){$(f).trigger("point",[e])}else{var b=widget.get(c);if(widget.check(b)){io.callUpdateHandler(f,b)}}},handleReceivedData:function(e){var b=0;var f=JSON.parse(e);switch(f.cmd){case"reloadPage":location.reload(true);break;case"item":for(b=0;b<f.items.length;b=b+2){io.updateWidget(f.items[b],f.items[b+1])}break;case"series":for(b=0;b<f.items.length;b++){var a=f.items[b].gad;var g=f.items[b].plotdata;var c=f.items[b].updatemode;$('[data-item*="'+a+'"]').each(function(){var h=widget.explode($(this).attr("data-item"));for(var j=0;j<h.length;j++){if(io.isPlot(this,h[j])){h[j]=io.splitPlotGAD(h[j]).gad}if(h[j]===a){if(io.isPlot(this,h[j])){io.updatePlot(this,a,g,c)}else{io.updateChart(this,a,g,c)}}}})}break;case"dialog":notify.info(f.header,f.content);break;case"proto":var d=f.ver;if(d!=io.protocolVersion){notify.info("Driver: fhem","Protocol mismatch<br />Driver is at version v"+io.protocolVersion+"<br />fhem is at version v"+d)}break;case"log":break}},open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.log(2,"socket.onopen");io.stopReconnectTimer();io.send({cmd:"proto",ver:io.protocolVersion});io.monitor();if(notify.exists()){notify.remove()}};io.socket.onmessage=function(a){io.log(2,"socket.onmessage: data= "+a.data);io.handleReceivedData(a.data)};io.socket.onerror=function(a){io.log(1,"socket.onerror: "+a)};io.socket.onclose=function(){io.log(1,"socket.onclose");io.close();io.startReconnectTimer()}},send:function(a){if(io.offline){io.log(2,"OFFLINE send() data: "+JSON.stringify(a))}else{if(io.socket.readyState==1){io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))));io.log(2,"send() data: "+JSON.stringify(a))}}},isSeries:function(e,b){var a=false;var d=$(e).attr("data-series");if(d){var f=d.split(",");for(var c=0;c<f.length;c++){if(f[c].trim()===b){a=true;break}}}return a},isPlot:function(b,a){var c=$(b).attr("data-widget");return c==="plot.period"||c==="plot.rtr"},isLog:function(b,a){var c=$(b).attr("data-widget");return c==="status.log"},isValue:function(b,a){return !io.isSeries(b,a)&&!io.isPlot(b,a)&&!io.isLog(b,a)},splitGADs:function(){io.ownGADs=[];io.fhemGADs=[];var c=Array();var g=Array();io.allGADs.forEach(function(k){var h=widget.explode($(k).attr("data-item"));for(var j=0;j<h.length;j++){if(io.isValue(k,h[j])){g[h[j]]=""}}});for(var f in g){c.push(f);if(io.offline){io.offlineGADs.push(f)}}if(io.gadFilter){var e=new RegExp(io.gadFilter);for(var d=0;d<c.length;d++){var a=c[d];var b=e.test(a);if(b){io.ownGADs.push(a)}else{io.fhemGADs.push(a)}}}else{io.fhemGADs=c}},splitPlotGAD:function(c){var b=c.split(".");var d=0;var a="";while(d<b.length-3){a+=b[d]+(d==b.length-4?"":".");d++}return{gad:a,mode:b[b.length-3],start:b[b.length-2],end:b[b.length-1]}},splitSeries:function(){io.ownSeries=[];io.fhemSeries=[];io.allGADs.forEach(function(q){var k=$(q).attr("data-item").split(",");for(var j=0;j<k.length;j++){var m=false;var e=k[j].trim();var l="";var b="";var f="";var d="";var n="";var h="complete";if(io.isSeries(q,e)){var g=$(q).attr("data-modes");var c=g.split(",");l=c.length>1?c[j].trim():g;b=$(q).attr("data-tmin");f=$(q).attr("data-tmax");d=$(q).attr("data-interval");n=$(q).attr("data-zoom");m=true}else{if(io.isPlot(q,e)){var o=io.splitPlotGAD(e);if($.inArray(o.mode,Array("avg","min","max","sum","diff","rate","on"))>=0){e=o.gad;l=o.mode;b=o.start;f=o.end;d="OnChange";n=$(q).attr("data-zoom");h="additional";m=true}}}if(m){var a={gad:e,mode:l,start:b,end:f==="0"?"now":f,interval:d,minzoom:n,updatemode:h};if(io.offline){io.offlineSeries.push(a)}if(io.gadFilter){var p=new RegExp(io.gadFilter);if(p.test(a.gad)){io.ownSeries.push(a)}else{io.fhemSeries.push(a)}}else{io.fhemSeries.push(a)}}}})},splitLogs:function(){io.ownLogs=[];io.fhemLogs=[];io.allGADs.forEach(function(d){var e=$(d).attr("data-item").split(",");for(var a=0;a<e.length;a++){if(io.isLog(d,e[a].trim())){var c={gad:e[a].trim(),size:$(d).attr("data-count"),interval:$(d).attr("data-interval")};if(io.offline){io.offlineLogs.push(c)}if(io.gadFilter){var b=new RegExp(io.gadFilter);if(b.test(c.gad)){io.ownLogs.push(c)}else{io.fhemLogs.push(c)}}else{io.fhemLogs.push(c)}}}})},getAllGADs:function(){io.action={};io.allGADs=[];var a=($._data($(document)[0],"events")||{})["update"];for(var c=0;c<a.delegateCount;c++){var b=a[c].selector;var f=/.*?data-widget?.="(.+?)".*/;f.exec(b);var e=RegExp.$1;var d=a[c].handler;io.action[e]={handler:d}}if($.mobile.activePage){$('[id^="'+$.mobile.activePage.attr("id")+'-"][data-item]').each(function(g,h){io.allGADs.push(this)})}},allGADs:[],fhemGADs:[],ownGADs:[],fhemSeries:[],ownSeries:[],fhemLogs:[],ownLogs:[],monitor:function(){if(io.offline||io.socket.readyState==1){io.logLoadTime("Monitor");io.getAllGADs();io.splitGADs();io.splitSeries();io.splitLogs();io.logLoadTime("Monitor calculated");io.log(1,"monitor (GADs:"+io.fhemGADs.length+", Series:"+io.fhemSeries.length+")");if(io.fhemGADs.length){io.send({cmd:"monitor",items:io.fhemGADs})}if(io.fhemSeries.length){io.send({cmd:"series",items:io.fhemSeries})}if(io.fhemLogs.length){io.send({cmd:"log",items:io.fhemLogs})}if(io.addon){io.addon.monitor(io.ownGADs,io.ownSeries,io.ownLogs)}io.logLoadTime("Monitor done")}},close:function(){if(io.socket!=null){io.socket.close();io.socket=null;io.log(1,"socket closed")}},loadTimeLog:"Load-Times\n",timeStamp:0,receivedGADs:0,resetLoadTime:function(){if(io.measureGADs){io.receivedGADs=0;io.loadTimeLog="Load-Times\n";io.logLoadTime("Start")}},logLoadTime:function(c){if(io.measureGADs){var b=new Date();var a=io.timeStamp==0?0:(b.getTime()-io.timeStamp);io.loadTimeLog+=b.toLocaleTimeString()+"."+("000"+b.getMilliseconds()).slice(-3)+" ("+a+" ms): "+c+"\n";io.timeStamp=b.getTime()}},showLoadTime:function(){if(io.measureGADs&&io.receivedGADs==io.gadsToMeasure){if(io.loadTimeLog){io.logLoadTime(io.receivedGADs+" GADs");alert(io.loadTimeLog)}}},timer:null,offlineGADs:[],offlineSeries:[],offlineLogs:[],simulateData:function(){for(j=0;j<io.offlineGADs.length;j++){var h=[];h.push(io.offlineGADs[j]);h.push((Math.random()*100).toFixed(1));io.handleReceivedData('{"cmd":"item", "items": '+JSON.stringify(h)+"}")}var c=new Date().getTime();for(var j=0;j<io.offlineSeries.length;j++){var l=$('[data-item*="'+io.offlineSeries[j].gad+'"]')[0];var b=$(l).attr("data-tmin");b=b?b:"2d";var m=$(l).attr("data-tmax");m=m?m:"now";var o=100;var r=$(l).attr("data-ymin");r=r?r*1:0;var f=$(l).attr("data-ymax");f=f?f*1:255;var a=new Date().getTime()-new Date().duration(b);var k=new Date().getTime()-new Date().duration(m);var e=Math.round((k-a)/o);var d=r+((f-r)/2);var q=(f-r)/20;var g=[];var p=0;while(a<=k&&++p<10000){d+=Math.random()*(2*q)-q;g.push([a,d.toFixed(2)*1]);a+=e}var n='{"cmd":"series", "items": [{"gad": "'+io.offlineSeries[j].gad+'", "updatemode": "complete", "plotdata": '+JSON.stringify(g)+" }]}";io.handleReceivedData(n)}}};