var io={logLevel:1,gadFilter:"",addonDriverFile:"",driverVersion:"1.06",address:"",port:"",read:function(a){io.log(1,"read (item="+a+")")},write:function(a,d){var c=false;if(io.gadFilter){var b=new RegExp(io.gadFilter);c=b.test(a)}if(c){if(io.addon){io.addon.write(a,d)}}else{io.log(2,"write (gad="+a+" val="+d+")");io.send({cmd:"item",id:a,val:d})}io.updateWidget(a,d)},trigger:function(a,b){if(io.addon){io.addon.trigger(a,b)}},init:function(a,b){io.log(1,"init [V"+io.driverVersion+"] (address="+a+" port="+b+")");io.address=a;io.port=b;io.open();if(io.addonDriverFile){$.getScript("driver/"+io.addonDriverFile).done(function(d,c){io.addon=new addonDriver();io.addon.init(io);io.addon.run()}).fail(function(e,d,c){io.addon=null})}},run:function(a){io.log(1,"run (readyState="+io.socket.readyState+")");io.resetLoadTime();if(io.addon){io.addon.run()}if(io.socket.readyState>1){io.open()}else{io.refreshWidgets();io.monitor()}},protocolVersion:"0.1",socket:null,rcTimer:null,addon:null,log:function(b,a){if(io.logLevel>=b){console.log("[io.fhem]: "+a)}},startReconnectTimer:function(){if(!io.rcTimer){io.log(1,"Reconnect timer started");io.rcTimer=setInterval(function(){io.log(1,"Reconnect timer fired");notify.add("ConnectionLost","connection","Driver: fhem","Connection to the fhem server lost!");notify.display();if(!io.socket){io.open()}},60000)}},stopReconnectTimer:function(){if(io.rcTimer){clearInterval(io.rcTimer);io.rcTimer=null;io.log(1,"Reconnect timer stopped")}},refreshWidgets:function(){$('[id^="'+$.mobile.activePage.attr("id")+'-"][data-item]').each(function(a){var b=widget.get(widget.explode($(this).attr("data-item")));if(widget.check(b)){var d=$(this).attr("data-widget").substr(0,5)=="plot.";if(d){$(this).trigger("update",[b])}else{var c=io.action[$(this).attr("data-widget")];if(c){c.handler.call(this,"update",[b])}else{io.log(0,$(this).attr("data-widget")+": Handler not found")}}}})},updateWidget:function(a,b){io.receivedGADs++;io.logLoadTime("GAD #"+io.receivedGADs);var c="";if(b===undefined||widget.buffer[a]!==b||(widget.buffer[a] instanceof Array&&widget.buffer[a].toString()!=b.toString())){widget.set(a,b);$('[data-item*="'+a+'"]').each(function(d){c=$(this).attr("data-widget");var f=widget.explode($(this).attr("data-item"));for(var h=0;h<f.length;h++){if(f[h]==a){var e=Array();var j=c.substr(0,5)=="plot.";if(j&&$("#"+this.id).highcharts()){}else{e=widget.get(f);if(widget.check(e)){if(j){$(this).trigger("update",[e])}else{var g=io.action[$(this).attr("data-widget")];if(g){g.handler.call(this,"update",[e])}else{io.log(0,c+": Handler not found")}}}}}}})}io.logLoadTime("OK ("+c+")");io.showLoadTime()},updateChart:function(a,b){$('[data-item*="'+a+'"]').each(function(c){var d=widget.explode($(this).attr("data-item"));for(var g=0;g<d.length;g++){if(d[g]===a){var f={gad:a,data:b};var e=io.action[$(this).attr("data-widget")];if(e){e.handler.call(this,"update",f)}else{io.log(0,widgetType+": Handler not found")}io.log(2,"series updated: "+f.gad+" size: "+f.data.length);break}}})},open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.log(2,"socket.onopen()");io.stopReconnectTimer();io.send({cmd:"proto",ver:io.protocolVersion});io.monitor();if(notify.exists()){notify.remove()}};io.socket.onmessage=function(d){var c,f;var e=JSON.parse(d.data);io.log(2,"onmessage() data= "+d.data);switch(e.cmd){case"reloadPage":location.reload(true);break;case"item":for(var a=0;a<e.items.length;a=a+2){c=e.items[a];f=e.items[a+1];io.updateWidget(c,f)}break;case"series":break;case"dialog":notify.info(e.header,e.content);break;case"proto":var b=e.ver;if(b!=io.protocolVersion){notify.info("Driver: fhem","Protocol mismatch<br />Driver is at version v"+io.protocolVersion+"<br />fhem is at version v"+b)}break;case"log":break}};io.socket.onerror=function(a){io.log(1,"socket.onerror: "+a)};io.socket.onclose=function(){io.log(1,"socket.onclose");io.close();io.startReconnectTimer()}},send:function(a){if(io.socket.readyState==1){io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))));io.log(2,"send() data: "+JSON.stringify(a))}},splitGADs:function(){io.ownGADs=[];io.fhemGADs=[];var c=Array();var g=Array();io.allGADs.forEach(function(k){var l=$(k).attr("data-widget");if(!(l=="status.log"||l.lastIndexOf("chart.",0)===0)||l.lastIndexOf("plot.",0)===0){var h=widget.explode($(k).attr("data-item"));for(var j=0;j<h.length;j++){if(!widget.checkseries(h[j])){g[h[j]]=""}}}});for(var f in g){c.push(f)}if(io.gadFilter){var e=new RegExp(io.gadFilter);for(var d=0;d<c.length;d++){var a=c[d];var b=e.test(a);if(b){io.ownGADs.push(a)}else{io.fhemGADs.push(a)}}}else{io.fhemGADs=c}},splitCharts:function(){io.ownSeries=[];io.fhemSeries=[];io.allGADs.forEach(function(d){var g=$(d).attr("data-widget");if(g.lastIndexOf("chart.",0)==0){var a=$(d).attr("data-item");var e=a.split(",");for(var b=0;b<e.length;b++){var f={gad:e[b].trim(),mode:$(d).attr("data-modes"),start:$(d).attr("data-tmin"),end:$(this).attr("data-tmax"),interval:$(d).attr("data-interval")};if(io.gadFilter){var c=new RegExp(io.gadFilter);if(c.test(f.gad)){io.ownSeries.push(f)}else{io.fhemSeries.push(f)}}else{io.fhemSeries.push(f)}}}})},splitLogs:function(){io.ownLogs=[];io.fhemLogs=[];io.allGADs.forEach(function(e){var g=$(e).attr("data-widget");if(g==="status.log"){var a=$(e).attr("data-item");var f=a.split(",");for(var b=0;b<f.length;b++){var d={gad:f[b].trim(),size:$(e).attr("data-count"),interval:$(e).attr("data-interval")};if(io.gadFilter){var c=new RegExp(io.gadFilter);if(c.test(d.gad)){io.ownLogs.push(d)}else{io.fhemLogs.push(d)}}else{io.fhemLogs.push(d)}}}})},getAllGADs:function(){io.action={};io.allGADs=[];var a=($._data($(document)[0],"events")||{})["update"];for(var c=0;c<a.delegateCount;c++){var b=a[c].selector;var f=/.*?data-widget="(.+?)".*/;f.exec(b);var e=RegExp.$1;var d=a[c].handler;io.action[e]={handler:d}}$('[id^="'+$.mobile.activePage.attr("id")+'-"][data-item]').each(function(g,h){io.allGADs.push(this)})},allGADs:[],fhemGADs:[],ownGADs:[],fhemSeries:[],ownSeries:[],fhemLogs:[],ownLogs:[],monitor:function(){if(io.socket.readyState==1){io.logLoadTime("Monitor");io.getAllGADs();io.splitGADs();io.splitCharts();io.splitLogs();io.logLoadTime("Monitor done");io.log(1,"monitor (GADs:"+io.fhemGADs.length+", Series:"+io.fhemSeries.length+")");if(io.fhemGADs.length){io.send({cmd:"monitor",items:io.fhemGADs})}if(io.fhemSeries.length){io.send({cmd:"series",items:io.fhemSeries})}if(io.fhemLogs.length){io.send({cmd:"log",items:io.fhemLogs})}if(io.addon){io.addon.monitor(io.ownGADs,io.ownSeries,io.ownLogs)}}},close:function(){if(io.socket!=null){io.socket.close();io.socket=null;io.log(1,"socket closed")}},gadsToMeasure:20,loadTimeLog:"Load-Times\n",timeStamp:0,receivedGADs:0,resetLoadTime:function(){io.receivedGADs=0;io.loadTimeLog="Load-Times\n";io.logLoadTime("Start")},logLoadTime:function(c){var b=new Date();var a=io.timeStamp==0?0:(b.getTime()-io.timeStamp);io.loadTimeLog+=b.toLocaleTimeString()+"."+("000"+b.getMilliseconds()).slice(-3)+" ("+a+" ms): "+c+"\n";io.timeStamp=b.getTime()},showLoadTime:function(){if(io.receivedGADs==io.gadsToMeasure){if(io.loadTimeLog){io.logLoadTime(io.receivedGADs+" GADs")}}}};