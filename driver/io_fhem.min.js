var io={logLevel:1,gadFilter:"",addonDriverFile:"",address:"",port:"",read:function(a){io.log(1,"read (item="+a+")")},write:function(a,b){io.log(1,"write (item="+a+" val="+b+")");io.send({cmd:"item",id:a,val:b});io.updateWidget(a,b)},trigger:function(a,b){io.log(1,"trigger")},init:function(a,b){io.log(1,"init (address="+a+" port="+b+")");io.address=a;io.port=b;io.open()},run:function(a){io.log(1,"run (readyState="+io.socket.readyState+")");if(io.socket.readyState>1){io.open()}else{widget.refresh();io.monitor()}},version:"0.1",socket:null,rcTimer:null,log:function(b,a){if(io.logLevel>=b){console.log("[io.fhem]: "+a)}},startReconnectTimer:function(){if(!io.rcTimer){io.log(1,"Reconnect timer started");io.rcTimer=setInterval(function(){io.log(1,"Reconnect timer fired");notify.add("ConnectionLost","connection","Driver: fhem","Connection to the fhem server lost!");notify.display();if(!io.socket){io.open()}},60000)}},stopReconnectTimer:function(){if(io.rcTimer){clearInterval(io.rcTimer);io.rcTimer=null;io.log(1,"Reconnect timer stopped")}},updateWidget:function(a,b){widget.update(a,b)},open:function(){io.socket=new WebSocket("ws://"+io.address+":"+io.port+"/");io.socket.onopen=function(){io.log(1,"socket.onopen()");io.stopReconnectTimer();io.send({cmd:"proto",ver:io.version});io.monitor();if(notify.exists()){notify.remove()}};io.socket.onmessage=function(d){var c,f;var e=JSON.parse(d.data);io.log(2,"onmessage() data= "+d.data);switch(e.cmd){case"reloadPage":location.reload(true);break;case"item":for(var a=0;a<e.items.length;a=a+2){c=e.items[a];f=e.items[a+1];io.updateWidget(c,f);io.log(2,"item updated: "+c+" val: "+f)}break;case"dialog":notify.info(e.header,e.content);break;case"proto":var b=e.ver;if(b!=io.version){notify.info("Driver: fhem","Protocol mismatch<br />Driver is at version v"+io.version+"<br />fhem is at version v"+b)}break;case"log":break}};io.socket.onerror=function(a){io.log(1,"socket.onerror: "+a)};io.socket.onclose=function(){io.log(1,"socket.onclose");io.close();io.startReconnectTimer()}},send:function(a){if(io.socket.readyState==1){io.socket.send(unescape(encodeURIComponent(JSON.stringify(a))));io.log(2,"send() data: "+JSON.stringify(a))}},monitor:function(){if(io.socket.readyState==1){var c=widget.listeners();io.log(1,"Total-GADs: "+c.length);var f=[];var g=[];if(io.gadFilter){var e=new RegExp(io.gadFilter);for(var d=0;d<c.length;d++){var a=c[d];var b=e.test(a);if(b){g.push(a)}else{f.push(a)}}io.log(1,"FHEM GADs: "+f.length);io.log(1,"Own GADs: "+g.length)}else{f=c}if(f.length){io.send({cmd:"monitor",items:f})}if(g.length){if(io.addonDriverFile){$.getScript("driver/"+io.addonDriverFile).done(function(i,h){io.log(1,io.addonDriverFile+" loaded");io.addon=new addonDriver();io.addon.run(io,g)}).fail(function(j,i,h){io.addon=null})}}}},close:function(){if(io.socket!=null){io.socket.close();io.socket=null;io.log(1,"socket closed");if(io.addon){io.addon.stop()}}}};